include:
  - metalk8s.req.python-kubernetes

{% set hostname = pillar.get('mark_control_plane_hostname', salt['network.get_hostname']()) %}

{% set kubeconfig = "/etc/kubernetes/admin.conf" %}
{% set context = "kubernetes-admin@kubernetes" %}

Apply control-plane master role label:
  kubernetes.node_label_present:
    - name: "node-role.kubernetes.io/master"
    - kubeconfig: {{ kubeconfig }}
    - context: {{ context }}
    - node: {{ hostname }}
    - value: ""
    - require:
      - pkg: Install Python Kubernetes client

Apply control-plane etcd role label:
  kubernetes.node_label_present:
    - name: "node-role.kubernetes.io/etcd"
    - kubeconfig: {{ kubeconfig }}
    - context: {{ context }}
    - node: {{ hostname }}
    - value: ""
    - require:
      - pkg: Install Python Kubernetes client

Apply control-plane bootstrap role label:
  kubernetes.node_label_present:
    - name: "node-role.kubernetes.io/bootstrap"
    - kubeconfig: {{ kubeconfig }}
    - context: {{ context }}
    - node: {{ hostname }}
    - value: ""
    - require:
      - pkg: Install Python Kubernetes client

Apply control-plane bootstrap taint:
  kubernetes.node_taints_present:
    - name: {{ hostname }}
    - kubeconfig: {{ kubeconfig }}
    - context: {{ context }}
    - taints:
        - key: "node-role.kubernetes.io/bootstrap"
          effect: "NoSchedule"
    - require:
      - pkg: Install Python Kubernetes client

Apply node version label:
  kubernetes.node_label_present:
    - kubeconfig: {{ kubeconfig }}
    - context: {{ context }}
    - name: "metalk8s.scality.com/version"
    - node: {{ hostname }}
    - value: "@@VERSION"
    - require:
      - pkg: Install Python Kubernetes client

Annotate with CRI socket information:
  kubernetes.node_annotation_present:
    - name: "kubeadm.alpha.kubernetes.io/cri-socket"
    - kubeconfig: {{ kubeconfig }}
    - context: {{ context }}
    - node: {{ hostname }}
    # TODO: the socket location may become configurable, we should make sure
    #       this value is accurate (hardcoded to the default value for now)
    - value: "/run/containerd/containerd.sock"
    - require:
      - pkg: Install Python Kubernetes client
